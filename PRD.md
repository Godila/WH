# PRD: WMS Marketplace — Система складского учёта для фулфилмента

## Контекст для LLM

Ты разрабатываешь систему складского учёта (WMS) для фулфилмента маркетплейсов РФ. Система заменяет Excel-таблицы для менеджеров (2-3 человека), которые управляют товарами на двух складах: основной (годный товар) и брак. Ключевая задача — автоматически пересчитывать остатки при любых операциях и вести журнал всех движений.

**Бизнес-модель клиента:**
- Фулфилмент для продавцов на Wildberries и Ozon
- Товары приходят от поставщиков, хранятся на складе
- Отгружаются в распределительные центры (РЦ) маркетплейсов
- Возвраты и брак обрабатываются внутри

---

## Бизнес-сущности

### Product (Товар)
Единица учёта в системе. Товар идентифицируется уникальными кодами для работы с маркетплейсами.

**Атрибуты:**
- `id` — уникальный идентификатор (UUID)
- `barcode` — штрихкод, уникален, обязателен
- `gtin` — глобальный код товара, уникален, опционален
- `seller_sku` — артикул продавца, опционален
- `size` — размер, опционален
- `brand` — бренд, опционален
- `color` — цвет, опционален
- `is_active` — флаг активности (soft delete)
- `created_at` — дата создания

**Бизнес-правила:**
- Barcode уникален в системе
- GTIN уникален в системе (если указан)
- При soft delete товар остаётся в базе, но is_active = false
- При создании товара автоматически создаются записи Stock и DefectStock с quantity = 0

### Stock (Остаток годного товара)
Текущий остаток годного товара на складе.

**Атрибуты:**
- `product_id` — ссылка на товар
- `quantity` — количество (неотрицательное)

### DefectStock (Остаток брака)
Текущий остаток бракованного товара.

**Атрибуты:**
- `product_id` — ссылка на товар
- `quantity` — количество (неотрицательное)

### Source (Источник / ПВЗ)
Справочник источников товаров: поставщики и пункты выдачи заказов (ПВЗ).

**Атрибуты:**
- `id` — уникальный идентификатор (UUID)
- `name` — название
- `description` — описание, опционально

**Seed-данные при инициализации:**
1. Поставщик РФ
2. ПВЗ Казань
3. ПВЗ Москва
4. Прямой поставщик

### DistributionCenter (Распределительный центр)
Справочник РЦ маркетплейсов (Wildberries, Ozon).

**Атрибуты:**
- `id` — уникальный идентификатор (UUID)
- `code` — код РЦ (например, WB-KAZAN)
- `name` — название
- `marketplace` — маркетплейс (WB или Ozon)

**Seed-данные при инициализации:**
- WB: Казань, Москва, Санкт-Петербург, Краснодар
- Ozon: Казань, Москва, Санкт-Петербург, Краснодар, Новосибирск

### User (Пользователь)
Менеджер, работающий с системой.

**Атрибуты:**
- `id` — уникальный идентификатор (UUID)
- `email` — email, уникален
- `hashed_password` — хеш пароля
- `is_active` — флаг активности

**Seed-данные при инициализации:**
- Admin: `admin@wms.example.com` / `admin123`

---

## 9 Складских операций

Система поддерживает 9 типов операций движения товара. Каждая операция атомарна — либо проходит полностью, либо откатывается.

### 1. RECEIPT (Приёмка)
Приёмка годного товара от поставщика.
- **Эффект:** Stock += quantity
- **Обязательные поля:** product_id, quantity
- **Опциональные поля:** —

### 2. RECEIPT_DEFECT (Приёмка брака)
Приёмка бракованного товара.
- **Эффект:** DefectStock += quantity
- **Обязательные поля:** product_id, quantity
- **Опциональные поля:** —

### 3. SHIPMENT_RC (Отгрузка в РЦ)
Отгрузка годного товара в распределительный центр маркетплейса.
- **Эффект:** Stock -= quantity
- **Обязательные поля:** product_id, quantity, distribution_center_id
- **Валидация:** Нельзя отгрузить больше, чем есть на Stock

### 4. RETURN_PICKUP (Возврат с ПВЗ)
Возврат годного товара с пункта выдачи.
- **Эффект:** Stock += quantity
- **Обязательные поля:** product_id, quantity, source_id

### 5. RETURN_DEFECT (Возврат брака)
Возврат бракованного товара с ПВЗ.
- **Эффект:** DefectStock += quantity
- **Обязательные поля:** product_id, quantity, source_id

### 6. SELF_PURCHASE (Самовыкуп)
Самовыкуп товара менеджером.
- **Эффект:** Stock += quantity
- **Обязательные поля:** product_id, quantity, source_id

### 7. WRITE_OFF (Списание в брак)
Перевод годного товара в брак.
- **Эффект:** Stock -= quantity, DefectStock += quantity
- **Обязательные поля:** product_id, quantity
- **Валидация:** Нельзя списать больше, чем есть на Stock

### 8. RESTORATION (Восстановление)
Перевод брака в годный товар (после проверки/ремонта).
- **Эффект:** DefectStock -= quantity, Stock += quantity
- **Обязательные поля:** product_id, quantity
- **Валидация:** Нельзя восстановить больше, чем есть на DefectStock

### 9. UTILIZATION (Утилизация)
Утилизация бракованного товара.
- **Эффект:** DefectStock -= quantity
- **Обязательные поля:** product_id, quantity
- **Валидация:** Нельзя утилизировать больше, чем есть на DefectStock

---

## StockMovement (Запись журнала движений)

Каждая операция создаёт запись в журнале.

**Атрибуты:**
- `id` — уникальный идентификатор (UUID)
- `operation_type` — тип операции (одно из 9 значений: receipt, receipt_defect, shipment_rc, return_pickup, return_defect, self_purchase, write_off, restoration, utilization)
- `product_id` — ссылка на товар
- `quantity` — количество
- `source_id` — ссылка на источник (опционально, обязательно для RETURN_*, SELF_PURCHASE)
- `distribution_center_id` — ссылка на РЦ (опционально, обязательно для SHIPMENT_RC)
- `created_at` — дата/время операции

---

## Функциональные требования

### Аутентификация

**AUTH-01:** Пользователь может войти с email и паролем
- Форма логина с полями email и password
- Валидация: email должен быть корректным, пароль обязателен

**AUTH-02:** При успешном логине выдаётся JWT токен
- Токен содержит email пользователя
- Токен имеет срок действия (настраивается)

**AUTH-03:** Все API эндпоинты защищены
- Требуется заголовок `Authorization: Bearer <token>`
- Без токена или с невалидным токеном — 401 Unauthorized
- При 401 клиент автоматически редиректит на страницу логина

**AUTH-04:** Можно получить информацию о текущем пользователе
- Эндпоинт возвращает email и другие данные пользователя

### Управление товарами

**PROD-01:** Создание товара
- Поля: barcode (обязательно), gtin, seller_sku, size, brand, color
- При создании автоматически создаются Stock и DefectStock с quantity = 0

**PROD-02-03:** Уникальность barcode и gtin
- При дублировании — ошибка валидации

**PROD-04:** Редактирование товара
- Можно изменить все поля кроме id

**PROD-05:** Удаление товара (soft delete)
- is_active = false
- Товар остаётся в базе, но не показывается в списках

**PROD-06:** Список товаров с пагинацией
- Параметры: page (номер страницы), page_size (размер страницы)
- Ответ: items[], total, page, page_size, pages

**PROD-07:** Поиск товара по баркоду
- Частичное совпадение

**PROD-08:** Список товаров с остатками
- Каждый товар включает stock_quantity и defect_quantity

### Справочники

**Sources:**
- CRUD операции
- Seed при инициализации

**DistributionCenters:**
- CRUD операции
- Seed при инициализации

### Журнал движений

**JRN-01:** Все операции записываются в StockMovements

**JRN-02:** Фильтрация по типу операции
- Параметр: operation_type

**JRN-03:** Фильтрация по товару
- Параметр: product_id или barcode

**JRN-04:** Фильтрация по дате
- Параметры: date_from, date_to

**JRN-05:** Пагинация журнала
- Параметры: page, page_size

**JRN-06:** Сортировка по дате DESC
- Новые записи сверху

### Импорт из Excel

**IMP-01:** Импорт товаров из Excel-файла
- Лист "Сводная"

**IMP-02:** Маппинг колонок:
- Баркод → barcode (обязательно)
- Артикул продавца → seller_sku
- Размер → size
- Бренд → brand
- Артикул WB → gtin
- АКТУАЛЬНЫЙ ОСТАТОК → stock_quantity
- БРАКИ → defect_quantity

**IMP-03:** Upsert логика
- Товар существует по баркоду → обновить
- Товар не существует → создать

**IMP-04:** Создание Stock и DefectStock при импорте
- Для новых товаров — создать записи с quantity из файла
- Для существующих — обновить quantity

**IMP-05:** Обработка пустых значений
- БРАКИ пусто → defect_quantity = 0

### Отчёты

**RPT-01:** Сводный отчёт
- total_products — количество товаров
- total_stock — общий остаток годного
- total_defect — общий остаток брака

---

## Требования к UI

### Страница логина
- Форма с email и password
- Кнопка "Войти"
- При ошибке — сообщение "Неверный email или пароль"
- При успешном логине — редирект на Dashboard

### Dashboard
- **Верхняя панель со статистикой:**
  - Всего товаров (число)
  - Общий остаток (число)
  - Всего брака (число, красным если > 0)

- **Таблица товаров:**
  - Колонки: Штрихкод, GTIN, SKU продавца, Бренд, Размер, Остаток, Брак
  - Пагинация
  - Поиск по штрихкоду/SKU
  - Брак > 0 подсвечивается красным

- **Кнопка "Провести операцию":**
  - Открывает модальное окно с формой

### Форма проведения операции
- Выпадающий список типов операции (9 вариантов с русскими названиями)
- Autocomplete товара (поиск по штрихкоду/SKU, минимум 2 символа)
- Поле количества (число, минимум 1)

- **Динамические поля:**
  - Если RETURN_PICKUP, RETURN_DEFECT, SELF_PURCHASE → показать выбор источника (ПВЗ)
  - Если SHIPMENT_RC → показать выбор РЦ

- **Валидация на клиенте:**
  - Все обязательные поля заполнены
  - Количество > 0

### Журнал движений
- **Фильтры:**
  - Выпадающий список типов операций
  - Диапазон дат (от — до)
  - Поиск по штрихкоду

- **Кнопки:** "Применить", "Сбросить"

- **Таблица:**
  - Колонки: Дата, Тип операции, Товар (штрихкод + бренд), Количество, Источник, РЦ
  - Пагинация
  - Сортировка по дате DESC

- **Цветовая кодировка типов операций:**
  - Зелёный: RECEIPT, RETURN_PICKUP, SELF_PURCHASE, RESTORATION (годное приходит)
  - Оранжевый: RECEIPT_DEFECT, RETURN_DEFECT (брак приходит)
  - Синий: SHIPMENT_RC (отгрузка)
  - Красный: WRITE_OFF, UTILIZATION (убыль)

### Общие требования к UI
- Loading-спиннеры при запросах
- Сообщения об ошибках API
- При 401 — автоматический редирект на логин
- Очистка localStorage при логауте

---

## API-интерфейс

### Аутентификация
```
POST /api/auth/login
Body: { "email": string, "password": string }
Response: { "access_token": string, "token_type": "bearer" }

GET /api/auth/me
Headers: Authorization: Bearer <token>
Response: { "id": string, "email": string, "is_active": boolean }
```

### Товары
```
GET /api/products/?page=1&page_size=20&barcode=<query>
Response: { "items": [...], "total": number, "page": number, "page_size": number, "pages": number }

POST /api/products/
Body: { "barcode": string, "gtin"?: string, "seller_sku"?: string, ... }
Response: { "id": string, "barcode": string, ... }

PUT /api/products/{id}
Body: { "barcode": string, ... }

DELETE /api/products/{id}
Response: 204 No Content
```

### Складские операции
```
POST /api/stock/movements
Body: { "operation_type": string, "product_id": string, "quantity": number, "source_id"?: string, "distribution_center_id"?: string }
Response: { "id": string, "operation_type": string, ... }

GET /api/stock/movements?page=1&page_size=20&operation_type=<type>&date_from=<date>&date_to=<date>&barcode=<barcode>
Response: { "items": [...], "total": number, ... }

GET /api/stock/summary
Response: { "total_products": number, "total_stock": number, "total_defect": number }
```

### Справочники
```
GET /api/sources/
Response: [{ "id": string, "name": string, "description": string|null }, ...]

GET /api/distribution-centers/
Response: [{ "id": string, "code": string, "name": string, "marketplace": string }, ...]
```

### Импорт
```
POST /api/import/excel
Body: multipart/form-data с файлом .xlsx
Response: { "created": number, "updated": number, "errors": string[] }
```

---

## Требования к развёртыванию

**INF-01:** Контейнеризация
- Система развёртывается через Docker Compose
- Три сервиса: база данных, backend, frontend
- Frontend раздаёт статику через nginx и проксирует /api на backend

**INF-02:** Миграции базы данных
- При старте автоматически применяются миграции

**INF-03:** Seed-данные
- При первом запуске создаются: admin пользователь, 4 источника, 9 РЦ

**INF-04:** Healthchecks
- Эндпоинт /health возвращает 200 OK
- Контейнеры проверяют здоровье друг друга

**INF-05:** API документация
- Swagger UI доступен по /api/docs
- ReDoc доступен по /api/redoc

---

## Что НЕ входит в MVP

| Функция | Причина |
|---------|---------|
| Учёт остатков на маркетплейсах | Только свои склады фулфилмента |
| Мобильное приложение | Web-first, desktop-first |
| API интеграция с маркетплейсами | Операции вводятся вручную |
| Real-time обновления | Polling достаточен |
| Роли и права | Все пользователи равны |
| Экспорт в Excel | Отложено до v2 |
| Barcode/QR сканирование | Отложено до v2 |

---

## Критерии приёмки

1. Менеджер может залогиниться и увидеть список товаров с остатками
2. Менеджер может провести любую из 9 операций — остатки пересчитываются корректно
3. Все операции отражаются в журнале движений
4. Можно отфильтровать журнал по типу, дате, товару
5. Можно импортировать товары из Excel
6. Dashboard показывает сводную статистику
7. При попытке отгрузить/утилизировать больше чем есть — ошибка
8. При истечении токена — автоматический редирект на логин
9. Система развёртывается одной командой через Docker Compose

---

*PRD версия: 1.0*
*Дата: 2026-02-20*
