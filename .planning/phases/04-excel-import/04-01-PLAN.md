---
phase: 04-excel-import
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - requirements.txt
  - app/schemas/import.py
autonomous: true
must_haves:
  truths:
    - "Import schemas define Excel row structure with all required columns"
    - "Import result schema tracks created/updated/error counts"
    - "openpyxl library is available for Excel parsing"
  artifacts:
    - path: "requirements.txt"
      provides: "openpyxl dependency for Excel file parsing"
      contains: "openpyxl"
    - path: "app/schemas/import.py"
      provides: "Pydantic schemas for import request/response"
      exports: ["ExcelImportRow", "ExcelImportResult", "ExcelImportError"]
  key_links:
    - from: "app/schemas/import.py"
      to: "Excel column names"
      via: "field mapping in schema"
      pattern: "barcode.*seller_sku.*size.*brand"
---

<objective>
Add openpyxl dependency and create Pydantic schemas for Excel import feature.

Purpose: Establish data contracts for Excel import before implementing service logic
Output: openpyxl in requirements.txt, import schemas in app/schemas/import.py
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Excel Column Mapping (from requirements)
| Excel Column | Model Field |
|--------------|-------------|
| Баркод | Product.barcode |
| Артикул продавца | Product.seller_sku |
| Размер | Product.size |
| Бренд | Product.brand |
| Артикул WB | (stored in seller_sku or separate) |
| АКТУАЛЬНЫЙ ОСТАТОК | Stock.quantity |
| БРАКИ | DefectStock.quantity |

# Existing product schema
@app/schemas/product.py
</context>

<tasks>

<task type="auto">
  <name>Add openpyxl dependency</name>
  <files>requirements.txt</files>
  <action>
Add `openpyxl>=3.1.0` to requirements.txt for Excel file parsing.
openpyxl supports read-only mode for memory-efficient streaming of large files.

Do NOT use pandas (too heavy) or xlrd (xlsx not supported well).
</action>
  <verify>grep -q "openpyxl" requirements.txt</verify>
  <done>openpyxl>=3.1.0 present in requirements.txt</done>
</task>

<task type="auto">
  <name>Create import schemas</name>
  <files>app/schemas/import.py</files>
  <action>
Create Pydantic schemas for Excel import:

1. **ExcelImportRow** - represents one row from Excel:
   - barcode: str (required, from "Баркод")
   - seller_sku: Optional[str] (from "Артикул продавца")
   - size: Optional[str] (from "Размер")
   - brand: Optional[str] (from "Бренд")
   - stock_quantity: int (required, from "АКТУАЛЬНЫЙ ОСТАТОК", default=0)
   - defect_quantity: int (from "БРАКИ", default=0 if empty/None)
   - row_number: int (for error reporting)

2. **ExcelImportError** - represents a validation error:
   - row_number: int
   - field: str (which field has the error)
   - message: str (error description)

3. **ExcelImportResult** - import summary:
   - total_rows: int
   - created: int (new products created)
   - updated: int (existing products updated)
   - errors: list[ExcelImportError]
   - success: bool (True if no errors)

4. **ExcelImportResponse** - API response:
   - result: ExcelImportResult
   - duration_seconds: float

Notes:
- All string fields should strip whitespace
- barcode is the primary key for upsert logic
- defect_quantity defaults to 0 (empty "БРАКИ" column)
</action>
  <verify>python -c "from app.schemas.import import ExcelImportRow, ExcelImportResult, ExcelImportError; print('OK')"</verify>
  <done>All 4 schemas importable without errors</done>
</task>

</tasks>

<verification>
- openpyxl in requirements.txt
- app/schemas/import.py exists with ExcelImportRow, ExcelImportResult, ExcelImportError, ExcelImportResponse
- All schemas are valid Pydantic models
</verification>

<success_criteria>
- openpyxl dependency added
- Import schemas define complete data contracts for Excel import
- Schemas handle edge cases (empty defect_quantity defaults to 0)
</success_criteria>

<output>
After completion, create `.planning/phases/04-excel-import/04-01-SUMMARY.md`
</output>
