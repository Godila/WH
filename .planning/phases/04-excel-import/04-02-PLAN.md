---
phase: 04-excel-import
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/services/excel_import.py
autonomous: true
must_haves:
  truths:
    - "Service can parse Excel file and extract rows from 'Сводная' sheet"
    - "Service validates ALL rows before any database write"
    - "Service performs upsert by barcode (create new or update existing)"
    - "Service updates Stock.quantity and DefectStock.quantity atomically"
    - "Empty 'БРАКИ' column values are treated as 0"
  artifacts:
    - path: "app/services/excel_import.py"
      provides: "ExcelImportService with parse, validate, import methods"
      exports: ["ExcelImportService"]
      min_lines: 100
  key_links:
    - from: "ExcelImportService"
      to: "openpyxl"
      via: "load_workbook with read_only=True"
      pattern: "load_workbook.*read_only"
    - from: "ExcelImportService.import_from_file"
      to: "Product/Stock/DefectStock models"
      via: "SQLAlchemy select + create/update"
      pattern: "select\\(Product\\).*barcode"
    - from: "Service"
      to: "batch processing"
      via: "500 rows per transaction"
      pattern: "batch.*transaction"
---

<objective>
Create ExcelImportService with parsing, validation, and batch upsert logic.

Purpose: Core business logic for Excel import with memory-efficient streaming and atomic batch processing
Output: app/services/excel_import.py with ExcelImportService class
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Import schemas from Plan 01
@.planning/phases/04-excel-import/04-01-SUMMARY.md

# Existing models
@app/models/product.py
@app/models/stock.py
@app/models/defect_stock.py

# Excel Column Mapping (Russian to English)
| Excel Column | Field |
|--------------|-------|
| Баркод | barcode |
| Артикул продавца | seller_sku |
| Размер | size |
| Бренд | brand |
| АКТУАЛЬНЫЙ ОСТАТОК | stock_quantity |
| БРАКИ | defect_quantity |

# Key requirements from research:
- Use openpyxl read_only=True for streaming (memory efficient)
- Validate ALL rows before ANY database write
- Process in batches of 500 rows per transaction
- Handle empty БРАКИ as 0
</context>

<tasks>

<task type="auto">
  <name>Create ExcelImportService with parsing</name>
  <files>app/services/excel_import.py</files>
  <action>
Create ExcelImportService class with:

```python
class ExcelImportService:
    COLUMN_MAPPING = {
        "Баркод": "barcode",
        "Артикул продавца": "seller_sku",
        "Размер": "size",
        "Бренд": "brand",
        "АКТУАЛЬНЫЙ ОСТАТОК": "stock_quantity",
        "БРАКИ": "defect_quantity",
    }
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def parse_excel(self, file_content: bytes) -> tuple[list[ExcelImportRow], list[ExcelImportError]]:
        """Parse Excel file, return rows and any parse errors."""
        # Use openpyxl with read_only=True for streaming
        # Find sheet named "Сводная"
        # Map column headers to field names
        # Extract rows, handle empty cells
        # Empty "БРАКИ" = 0
    
    async def validate_rows(self, rows: list[ExcelImportRow]) -> list[ExcelImportError]:
        """Validate all rows, return errors. NO database writes here."""
        # Check barcode is not empty
        # Check stock_quantity is valid integer
        # Check defect_quantity is valid integer
        # Return list of errors with row numbers
    
    async def import_batch(self, rows: list[ExcelImportRow]) -> tuple[int, int]:
        """Import a batch of validated rows. Returns (created, updated)."""
        # For each row:
        #   1. Select Product by barcode
        #   2. If exists: update product fields + update Stock/DefectStock
        #   3. If not exists: create Product + Stock + DefectStock
        # Commit transaction
    
    async def import_from_file(self, file_content: bytes) -> ExcelImportResult:
        """Main entry point. Parse, validate, import in batches."""
        # 1. parse_excel()
        # 2. validate_rows() - if errors, return early (NO db writes)
        # 3. Split into batches of 500
        # 4. import_batch() for each batch
        # 5. Return result
```

Key implementation details:
1. **Parsing**: Use `openpyxl.load_workbook(BytesIO(file_content), read_only=True)` for memory efficiency
2. **Sheet finding**: Look for sheet named exactly "Сводная" (case-sensitive)
3. **Column mapping**: Read header row, build column index mapping
4. **Empty cells**: Treat None/empty as 0 for numeric fields, None for optional strings
5. **Validation**: Check ALL rows first, return errors if any - DO NOT write to DB if validation fails
6. **Batch size**: 500 rows per transaction to balance memory and performance
7. **Upsert logic**: 
   - Select Product by barcode
   - If found: UPDATE product fields, UPDATE stock.quantity, UPDATE defect_stock.quantity
   - If not found: INSERT product, INSERT stock, INSERT defect_stock
8. **GTIN handling**: For new products without GTIN in Excel, generate placeholder or skip - ASK USER

IMPORTANT: GTIN is a required unique field in Product model. The Excel file does NOT contain GTIN column.
Options:
a) Generate placeholder GTIN from barcode (e.g., pad/truncate to 14 chars)
b) Skip GTIN and make it optional in model (breaking change)
c) Use barcode as GTIN (if barcode is 14 digits)

For this implementation: Use barcode as GTIN if barcode is 13-14 digits, otherwise generate "IMP" + barcode padded to 14 chars.
</action>
  <verify>python -c "from app.services.excel_import import ExcelImportService; print('OK')"</verify>
  <done>ExcelImportService class importable with parse_excel, validate_rows, import_batch, import_from_file methods</done>
</task>

</tasks>

<verification>
- ExcelImportService exists in app/services/excel_import.py
- Service has parse_excel, validate_rows, import_batch, import_from_file methods
- Column mapping matches Russian column names from requirements
- Service uses read_only mode for memory efficiency
- Validation happens before any database writes
- Batch processing with 500 rows per transaction
</verification>

<success_criteria>
- Service can parse Excel file with "Сводная" sheet
- Service validates all rows and returns errors without DB writes
- Service performs upsert by barcode (create new or update existing)
- Service updates Stock.quantity and DefectStock.quantity atomically
- Empty "БРАКИ" values are treated as 0
</success_criteria>

<output>
After completion, create `.planning/phases/04-excel-import/04-02-SUMMARY.md`
</output>
