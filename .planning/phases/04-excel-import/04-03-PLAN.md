---
phase: 04-excel-import
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - app/api/import.py
  - app/main.py
autonomous: false
must_haves:
  truths:
    - "Manager can POST Excel file to /api/import/excel endpoint"
    - "API returns structured response with created/updated/error counts"
    - "Import handles large files without memory issues"
    - "Import is protected by JWT authentication"
  artifacts:
    - path: "app/api/import.py"
      provides: "Excel import API endpoint"
      exports: ["router"]
    - path: "app/main.py"
      provides: "Router registration"
      contains: "import.*router"
  key_links:
    - from: "/api/import/excel"
      to: "ExcelImportService"
      via: "POST handler"
      pattern: "ExcelImportService.*import_from_file"
    - from: "router"
      to: "main.py"
      via: "include_router"
      pattern: "include_router.*import"
---

<objective>
Create Excel import API endpoint and wire it to the application.

Purpose: Expose Excel import functionality via REST API with file upload
Output: app/api/import.py with POST /api/import/excel endpoint, router registered in main.py
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Import service from Plan 02
@.planning/phases/04-excel-import/04-02-SUMMARY.md

# Import schemas from Plan 01
@.planning/phases/04-excel-import/04-01-SUMMARY.md

# Existing API structure
@app/api/products.py
@app/main.py
</context>

<tasks>

<task type="auto">
  <name>Create import API endpoint</name>
  <files>app/api/import.py</files>
  <action>
Create import router with file upload endpoint:

```python
from fastapi import APIRouter, Depends, UploadFile, File, HTTPException
from sqlalchemy.ext.asyncio import AsyncSession

from app.database import get_db
from app.api.deps import get_current_user
from app.models.user import User
from app.services.excel_import import ExcelImportService
from app.schemas.import import ExcelImportResponse, ExcelImportResult

router = APIRouter(prefix="/import", tags=["import"])

@router.post("/excel", response_model=ExcelImportResponse)
async def import_excel(
    file: UploadFile = File(..., description="Excel file with 'Сводная' sheet"),
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user),
) -> ExcelImportResponse:
    """
    Import products from Excel file.
    
    - File must contain a sheet named 'Сводная'
    - Required columns: Баркод, АКТУАЛЬНЫЙ ОСТАТОК
    - Optional columns: Артикул продавца, Размер, Бренд, БРАКИ
    - Empty БРАКИ values are treated as 0
    - Products are created or updated by barcode (upsert)
    
    Returns summary with created/updated counts and any errors.
    """
    import time
    start_time = time.time()
    
    # Validate file type
    if not file.filename or not file.filename.endswith(('.xlsx', '.xls')):
        raise HTTPException(
            status_code=400,
            detail="File must be Excel format (.xlsx or .xls)"
        )
    
    # Read file content
    content = await file.read()
    
    # Import
    service = ExcelImportService(db)
    result = await service.import_from_file(content)
    
    duration = time.time() - start_time
    
    return ExcelImportResponse(
        result=result,
        duration_seconds=round(duration, 2)
    )
```

Key implementation points:
1. File upload uses FastAPI's UploadFile with File(...)
2. Validate file extension (.xlsx, .xls)
3. Read entire content into memory (ok for typical Excel sizes, streaming would be more complex)
4. Service handles all parsing and validation
5. Return structured response with timing
6. Protected by get_current_user dependency
</action>
  <verify>python -c "from app.api.import import router; print('OK')"</verify>
  <done>Import router with POST /excel endpoint importable</done>
</task>

<task type="auto">
  <name>Register import router in main.py</name>
  <files>app/main.py</files>
  <action>
Add import router to FastAPI app in main.py:

1. Import the router: `from app.api.import import router as import_router`
2. Register it: `app.include_router(import_router, prefix="/api")`

The full path will be /api/import/excel

Follow the pattern used for other routers (products, stock, etc.)
</action>
  <verify>grep -q "from app.api.import import" app/main.py && grep -q "import_router" app/main.py</verify>
  <done>Import router registered and accessible at /api/import/excel</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Excel import feature with:
- POST /api/import/excel endpoint
- File upload handling (.xlsx, .xls)
- Parsing of "Сводная" sheet
- Column mapping for Russian headers
- Upsert by barcode (create new or update existing)
- Stock.quantity and DefectStock.quantity updates
- Empty "БРАКИ" = 0 handling
- Batch processing (500 rows per transaction)
- JWT authentication protection
</what-built>
  <how-to-verify>
1. Start the server: `uvicorn app.main:app --reload`
2. Get JWT token: `curl -X POST http://localhost:8000/api/auth/login -H "Content-Type: application/json" -d '{"email":"admin@example.com","password":"admin123"}'`
3. Create a test Excel file with "Сводная" sheet containing:
   | Баркод | Артикул продавца | Размер | Бренд | АКТУАЛЬНЫЙ ОСТАТОК | БРАКИ |
   |--------|------------------|--------|-------|-------------------|-------|
   | 4601234567890 | SKU001 | M | TestBrand | 100 | 5 |
   | 4601234567891 | SKU002 | L | TestBrand | 50 | |
4. Upload file: `curl -X POST http://localhost:8000/api/import/excel -H "Authorization: Bearer <token>" -F "file=@test.xlsx"`
5. Verify response contains created=2, updated=0
6. Check products were created via GET /api/products
7. Re-upload same file, verify response shows created=0, updated=2
8. Check stock quantities updated correctly
</how-to-verify>
  <resume-signal>Type "approved" if import works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- Import router exists at app/api/import.py
- POST /api/import/excel endpoint accepts file upload
- Router registered in main.py
- Endpoint protected by JWT auth
- Swagger docs show the endpoint
</verification>

<success_criteria>
- Manager can POST Excel file to /api/import/excel
- File must have "Сводная" sheet
- New products are created when barcode doesn't exist
- Existing products are updated when barcode exists
- Stock.quantity updated from "АКТУАЛЬНЫЙ ОСТАТОК"
- DefectStock.quantity updated from "БРАКИ" (0 if empty)
- Response includes created/updated counts and any errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-excel-import/04-03-SUMMARY.md`
</output>
