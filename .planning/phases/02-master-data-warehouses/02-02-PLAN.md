---
phase: 02-master-data-warehouses
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - app/api/products.py
  - app/main.py
autonomous: true

must_haves:
  truths:
    - "POST /api/products creates product with auto-created Stock and DefectStock records"
    - "Duplicate barcode returns 400 error"
    - "Duplicate GTIN returns 400 error"
    - "GET /api/products returns paginated list with stock_quantity and defect_quantity"
    - "GET /api/products?barcode=xxx searches by barcode"
    - "PUT /api/products/{id} updates product fields"
    - "DELETE /api/products/{id} sets is_deleted=True (soft delete)"
    - "Soft-deleted products are excluded from list by default"
  artifacts:
    - path: "app/api/products.py"
      provides: "Products CRUD API with auto-stock creation"
      exports: ["router"]
      min_lines: 150
    - path: "app/main.py"
      provides: "Router registration"
      contains: "products.router"
  key_links:
    - from: "app/api/products.py"
      to: "app/models/product.py"
      via: "from app.models.product import Product"
      pattern: "from app.models"
    - from: "app/api/products.py"
      to: "Stock/DefectStock"
      via: "Auto-creation in create_product"
      pattern: "Stock\(|DefectStock\("
    - from: "app/main.py"
      to: "app/api/products.py"
      via: "include_router(products.router)"
      pattern: "products.router"
---

<objective>
Create Products CRUD API with automatic Stock/DefectStock creation, pagination, barcode search, and soft delete. Wire the router into the FastAPI application.

Purpose: Enable managers to manage products through REST API with automatic stock record initialization.
Output: Working /api/products endpoints with all required functionality.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

## Reference: Phase 2 Plan 01 Output
- Product, Stock, DefectStock models exist
- Product schemas exist including ProductWithStockResponse
- Migration 002 creates tables

## Existing API Pattern (from app/api/sources.py):
```python
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession
from app.database import get_db
from app.api.deps import get_current_user

router = APIRouter(prefix="/sources", tags=["sources"])

@router.get("/", response_model=list[SourceResponse])
async def list_sources(
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user),
) -> list[Source]:
    result = await db.execute(select(Source).order_by(Source.name))
    return list(result.scalars().all())

@router.post("/", response_model=SourceResponse, status_code=status.HTTP_201_CREATED)
async def create_source(data: SourceCreate, db: AsyncSession = Depends(get_db), current_user: User = Depends(get_current_user)) -> Source:
    # Check duplicate
    # Create and return
```

## Requirements to Implement

- PROD-01: Create product with barcode, gtin, seller_sku, size, brand, color
- PROD-02: Barcode unique constraint (return 400 on duplicate)
- PROD-03: GTIN unique constraint (return 400 on duplicate)
- PROD-04: Update product
- PROD-05: Soft delete (set is_deleted=True)
- PROD-06: List with pagination (page, page_size params)
- PROD-07: Search by barcode (query param ?barcode=xxx)
- PROD-08: List includes stock_quantity, defect_quantity
- STOCK-01: Auto-create Stock with quantity=0
- STOCK-02: Auto-create DefectStock with quantity=0

## Database Models Available
- Product: id, barcode, gtin, seller_sku, size, brand, color, is_deleted, created_at, updated_at
- Stock: id, product_id (FK unique), quantity
- DefectStock: id, product_id (FK unique), quantity
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Products CRUD API</name>
  <files>app/api/products.py</files>
  <action>
Create complete Products API following the established pattern from sources.py:

**Imports needed:**
- FastAPI: APIRouter, Depends, HTTPException, status, Query
- SQLAlchemy: select, func, or_
- Models: Product, Stock, DefectStock, User
- Schemas: ProductCreate, ProductUpdate, ProductResponse, ProductWithStockResponse, ProductListResponse
- Dependencies: get_db, get_current_user

**Endpoints to implement:**

**1. POST /api/products/ - Create product**
- Accept ProductCreate body
- Check barcode uniqueness (400 if exists): `select(Product).where(Product.barcode == data.barcode)`
- Check GTIN uniqueness (400 if exists): `select(Product).where(Product.gtin == data.gtin)`
- Create Product instance
- Create Stock(product_id=product.id, quantity=0)
- Create DefectStock(product_id=product.id, quantity=0)
- Add all three to session, commit, refresh
- Return ProductResponse, status 201

**2. GET /api/products/ - List products with pagination**
- Query params: page (default 1), page_size (default 20, max 100), barcode (optional search)
- Filter: is_deleted=False (exclude soft-deleted)
- If barcode param: filter with ilike search `Product.barcode.ilike(f"%{barcode}%")`
- Use selectinload or join to get Stock and DefectStock in same query for efficiency
- Calculate total with `select(func.count()).select_from(Product).where(...)`
- Return ProductListResponse with pagination metadata

**3. GET /api/products/{product_id} - Get single product**
- Filter by id AND is_deleted=False
- Return 404 if not found
- Return ProductResponse

**4. PUT /api/products/{product_id} - Update product**
- Find product (exclude deleted)
- Return 404 if not found
- If barcode being updated: check uniqueness (excluding current product)
- If gtin being updated: check uniqueness (excluding current product)
- Use model_dump(exclude_unset=True) for partial updates
- Commit and return ProductResponse

**5. DELETE /api/products/{product_id} - Soft delete**
- Find product (exclude already deleted)
- Return 404 if not found
- Set is_deleted=True
- Commit
- Return 204 No Content

**Pagination calculation:**
```python
offset = (page - 1) * page_size
pages = (total + page_size - 1) // page_size  # ceiling division
```

IMPORTANT: Always filter is_deleted=False in list/get operations. Only DELETE sets it to True.
  </action>
  <verify>
grep -l "router.*products" app/api/products.py && \
grep -E "POST|GET|PUT|DELETE" app/api/products.py | head -10 && \
grep -E "Stock\(|DefectStock\(" app/api/products.py && \
grep -E "is_deleted.*False|is_deleted.*True" app/api/products.py
  </verify>
  <done>
Products API with CRUD, pagination, barcode search, auto-stock creation, and soft delete working.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Products router into FastAPI app</name>
  <files>app/main.py</files>
  <action>
Update app/main.py to include the products router:

1. Add import: `from app.api import auth, sources, distribution_centers, products`

2. Add router registration after other routers:
   `app.include_router(products.router, prefix="/api")`

The router already has prefix="/products" defined, so the full path will be /api/products/

Do NOT modify other routers or the lifespan function.
  </action>
  <verify>
grep -E "from app.api.*products|products.router" app/main.py
  </verify>
  <done>
Products router registered at /api/products/* and visible in Swagger docs.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. All endpoints accessible via /api/products/*
2. POST creates Stock and DefectStock automatically
3. Duplicate barcode/GTIN returns 400
4. Pagination works with correct metadata
5. Barcode search filters results
6. Soft delete hides from list but preserves data
7. Swagger docs at /docs show all endpoints
</verification>

<success_criteria>
- [ ] POST /api/products creates product + Stock(quantity=0) + DefectStock(quantity=0)
- [ ] Duplicate barcode returns HTTP 400 with error message
- [ ] Duplicate GTIN returns HTTP 400 with error message
- [ ] GET /api/products?page=1&page_size=20 returns paginated list with stock info
- [ ] GET /api/products?barcode=search_term filters by barcode
- [ ] PUT /api/products/{id} updates product with uniqueness checks
- [ ] DELETE /api/products/{id} sets is_deleted=True
- [ ] Soft-deleted products excluded from GET /api/products
- [ ] Router visible in Swagger at /docs
</success_criteria>

<output>
After completion, create `.planning/phases/02-master-data-warehouses/02-02-SUMMARY.md`
</output>
