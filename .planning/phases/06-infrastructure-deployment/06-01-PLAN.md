---
phase: 06-infrastructure-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - alembic/env.py
  - Dockerfile.backend
  - .dockerignore
autonomous: true

must_haves:
  truths:
    - "alembic migrations read DATABASE_URL from environment variable"
    - "Dockerfile.backend installs curl for healthcheck"
    - "Dockerfile.backend runs migrations on startup"
    - "Dockerfile.backend uses fastapi run for production"
    - ".dockerignore excludes unnecessary files from build context"
  artifacts:
    - path: "alembic/env.py"
      provides: "Environment-aware database URL for migrations"
      contains: "settings.DATABASE_URL"
    - path: "Dockerfile.backend"
      provides: "Backend container image"
      contains: "FROM python:3.12"
      min_lines: 20
    - path: ".dockerignore"
      provides: "Build context exclusions"
      contains: ".git"
  key_links:
    - from: "alembic/env.py"
      to: "app.core.config.settings"
      via: "import"
      pattern: "from app.core.config import settings"
    - from: "Dockerfile.backend"
      to: "requirements.txt"
      via: "COPY"
      pattern: "COPY requirements.txt"
---

<objective>
Create Docker image for the FastAPI backend with environment-aware migrations.

Purpose: Enable containerized backend deployment with automatic migrations and healthcheck support.
Output: Dockerfile.backend, updated alembic/env.py, .dockerignore
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-infrastructure-deployment/06-CONTEXT.md
@.planning/phases/06-infrastructure-deployment/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Update alembic/env.py to read DATABASE_URL from environment</name>
  <files>alembic/env.py</files>
  <action>
    Modify alembic/env.py to use DATABASE_URL from environment instead of alembic.ini.
    
    Add after the imports (around line 14):
    ```python
    from app.core.config import settings
    
    # Override sqlalchemy.url with environment variable
    config.set_main_option("sqlalchemy.url", settings.DATABASE_URL)
    ```
    
    This is critical for Docker deployment where the database hostname changes from 'localhost' to 'postgres'.
    
    DO NOT remove existing code - just add the override after `config = context.config`.
  </action>
  <verify>
    ```bash
    grep -n "settings.DATABASE_URL" alembic/env.py && grep -n "set_main_option" alembic/env.py
    ```
  </verify>
  <done>alembic/env.py imports settings and overrides sqlalchemy.url with settings.DATABASE_URL</done>
</task>

<task type="auto">
  <name>Create Dockerfile.backend for FastAPI</name>
  <files>Dockerfile.backend</files>
  <action>
    Create Dockerfile.backend in project root with the following structure:
    
    ```dockerfile
    FROM python:3.12

    WORKDIR /app

    # Install system dependencies (curl for healthcheck)
    RUN apt-get update && apt-get install -y --no-install-recommends \
        curl \
        && rm -rf /var/lib/apt/lists/*

    # Copy requirements first for better caching
    COPY requirements.txt .
    RUN pip install --no-cache-dir --upgrade pip && \
        pip install --no-cache-dir -r requirements.txt

    # Copy application code
    COPY app/ ./app/
    COPY alembic/ ./alembic/
    COPY alembic.ini .

    # Expose port
    EXPOSE 8000

    # Run migrations and start server
    CMD ["sh", "-c", "alembic upgrade head && fastapi run app/main.py --host 0.0.0.0 --port 8000"]
    ```
    
    Key points:
    - Python 3.12 base image (matches project requirements)
    - curl installed for healthcheck support
    - Requirements copied first for Docker layer caching
    - Alembic migrations run on container startup
    - `fastapi run` for production (no auto-reload)
  </action>
  <verify>
    ```bash
    cat Dockerfile.backend | grep -E "FROM python:3.12|curl|alembic upgrade|fastapi run"
    ```
  </verify>
  <done>Dockerfile.backend exists with Python 3.12, curl, migrations on startup, and fastapi run command</done>
</task>

<task type="auto">
  <name>Create .dockerignore</name>
  <files>.dockerignore</files>
  <action>
    Create .dockerignore in project root to exclude unnecessary files from Docker build context:
    
    ```
    # Environment files
    .env
    .env.*
    !.env.example

    # Python
    __pycache__
    *.py[cod]
    *$py.class
    .Python
    *.so
    .venv
    venv/
    ENV/

    # Node
    node_modules
    frontend/node_modules
    frontend/dist

    # Git
    .git
    .gitignore

    # IDE
    .idea
    .vscode
    *.swp
    *.swo

    # Docker
    docker-compose*.yml
    Dockerfile*

    # Planning
    .planning

    # Misc
    *.log
    *.md
    !README.md
    opencode.json
    ```
    
    This reduces build context size and prevents secrets from being included in images.
  </action>
  <verify>
    ```bash
    cat .dockerignore | grep -E "\.env|node_modules|\.git|__pycache__"
    ```
  </verify>
  <done>.dockerignore exists and excludes .env, node_modules, .git, __pycache__, and .planning</done>
</task>

</tasks>

<verification>
```bash
# Verify all files exist
ls -la Dockerfile.backend .dockerignore

# Verify alembic uses environment variable
grep "settings.DATABASE_URL" alembic/env.py
```
</verification>

<success_criteria>
- alembic/env.py reads DATABASE_URL from app.core.config.settings
- Dockerfile.backend exists with Python 3.12, curl, and fastapi run
- .dockerignore excludes secrets and unnecessary files
</success_criteria>

<output>
After completion, create `.planning/phases/06-infrastructure-deployment/06-01-SUMMARY.md`
</output>
