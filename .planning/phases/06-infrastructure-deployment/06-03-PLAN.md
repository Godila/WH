---
phase: 06-infrastructure-deployment
plan: 03
type: execute
wave: 2
depends_on:
  - 06-01
  - 06-02
files_modified:
  - docker-compose.yml
autonomous: false

must_haves:
  truths:
    - "docker-compose up starts all 3 services (postgres, backend, frontend)"
    - "PostgreSQL container is healthy and accepting connections"
    - "Backend container runs migrations and starts FastAPI"
    - "Frontend container serves React app and proxies API"
    - "All containers have healthchecks defined"
    - "All containers restart automatically on failure"
    - "Database data persists across container restarts"
  artifacts:
    - path: "docker-compose.yml"
      provides: "Multi-service orchestration"
      contains: "condition: service_healthy"
      min_lines: 60
  key_links:
    - from: "docker-compose.yml"
      to: "Dockerfile.backend"
      via: "build.dockerfile"
      pattern: "dockerfile: Dockerfile.backend"
    - from: "docker-compose.yml"
      to: "Dockerfile.frontend"
      via: "build.dockerfile"
      pattern: "dockerfile: Dockerfile.frontend"
    - from: "backend service"
      to: "postgres service"
      via: "depends_on.condition: service_healthy"
    - from: "frontend service"
      to: "backend service"
      via: "depends_on.condition: service_healthy"
---

<objective>
Create docker-compose.yml to orchestrate all services with healthchecks and proper startup ordering.

Purpose: Enable single-command deployment with `docker-compose up` that brings up the complete system.
Output: docker-compose.yml, verification that all services start correctly
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-infrastructure-deployment/06-CONTEXT.md
@.planning/phases/06-infrastructure-deployment/06-RESEARCH.md
@.planning/phases/06-infrastructure-deployment/06-01-SUMMARY.md
@.planning/phases/06-infrastructure-deployment/06-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create docker-compose.yml with healthchecks and networking</name>
  <files>docker-compose.yml</files>
  <action>
    Create docker-compose.yml in project root:
    
    ```yaml
    services:
      postgres:
        image: postgres:16
        restart: unless-stopped
        environment:
          POSTGRES_DB: wms
          POSTGRES_USER: ${DB_USER:-postgres}
          POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
        volumes:
          - postgres_data:/var/lib/postgresql/data
        healthcheck:
          test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
          interval: 10s
          timeout: 5s
          retries: 5
          start_period: 10s
        networks:
          - wms-network

      backend:
        build:
          context: .
          dockerfile: Dockerfile.backend
        restart: unless-stopped
        environment:
          DATABASE_URL: postgresql+asyncpg://${DB_USER:-postgres}:${DB_PASSWORD:-postgres}@postgres:5432/wms
          SECRET_KEY: ${SECRET_KEY:-change-me-in-production}
          DEBUG: "false"
        depends_on:
          postgres:
            condition: service_healthy
        healthcheck:
          test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
          interval: 30s
          timeout: 10s
          retries: 3
          start_period: 40s
        networks:
          - wms-network

      frontend:
        build:
          context: .
          dockerfile: Dockerfile.frontend
        restart: unless-stopped
        ports:
          - "80:80"
        depends_on:
          backend:
            condition: service_healthy
        healthcheck:
          test: ["CMD", "curl", "-f", "http://localhost/health"]
          interval: 30s
          timeout: 5s
          retries: 3
        networks:
          - wms-network

    volumes:
      postgres_data:

    networks:
      wms-network:
        driver: bridge
    ```
    
    Key points:
    - `depends_on` with `condition: service_healthy` ensures proper startup order
    - Named volume `postgres_data` for database persistence
    - Bridge network `wms-network` for inter-service communication
    - `restart: unless-stopped` for automatic restarts
    - Only frontend exposes port 80 externally
    - Backend uses postgres hostname (not localhost)
    - Healthchecks for all 3 services
  </action>
  <verify>
    ```bash
    cat docker-compose.yml | grep -E "condition: service_healthy|restart: unless-stopped|postgres_data|wms-network"
    ```
  </verify>
  <done>docker-compose.yml exists with 3 services, healthchecks, depends_on conditions, named volume, and bridge network</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Docker deployment infrastructure:
    - docker-compose.yml with postgres, backend, frontend services
    - All services have healthchecks
    - Proper startup ordering with depends_on conditions
    - Named volume for database persistence
    - Automatic restart on failure
  </what-built>
  <how-to-verify>
    1. Build and start all services:
       ```bash
       cd /root/WH
       docker compose up -d --build
       ```
    
    2. Wait for services to become healthy (about 30-60 seconds):
       ```bash
       docker compose ps
       ```
       All services should show "healthy" status.
    
    3. Check backend health:
       ```bash
       docker compose exec backend curl -f http://localhost:8000/health
       ```
       Should return: `{"status":"ok"}`
    
    4. Check frontend health (from host):
       ```bash
       curl http://localhost/health
       ```
       Should return: `ok`
    
    5. Test API through nginx proxy:
       ```bash
       curl http://localhost/api/health
       ```
       Should return: `{"status":"ok"}`
    
    6. Verify database persistence (data survives restart):
       ```bash
       docker compose restart postgres
       # Wait 15 seconds
       docker compose exec postgres pg_isready -U postgres -d wms
       ```
       Should return: "accepting connections"
  </how-to-verify>
  <resume-signal>Type "approved" if all services are healthy, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
```bash
# Verify docker-compose.yml structure
docker compose config --quiet

# Verify all services defined
docker compose config --services | grep -E "postgres|backend|frontend"
```
</verification>

<success_criteria>
- docker-compose.yml has 3 services with healthchecks
- `docker compose up -d --build` succeeds
- All 3 containers show "healthy" status
- Backend /health returns {"status":"ok"}
- Frontend serves React app at http://localhost
- API proxy works at http://localhost/api/*
</success_criteria>

<output>
After completion, create `.planning/phases/06-infrastructure-deployment/06-03-SUMMARY.md`
</output>
