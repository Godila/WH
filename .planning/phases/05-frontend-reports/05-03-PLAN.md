---
phase: 05-frontend-reports
plan: 03
type: execute
wave: 3
depends_on:
  - "05-02"
files_modified:
  - frontend/src/pages/Movements/OperationForm.tsx
  - frontend/src/components/products/ProductSelect.tsx
  - frontend/src/components/common/SourceSelect.tsx
  - frontend/src/components/common/DCSelect.tsx
  - frontend/src/utils/operationFields.ts
  - frontend/src/utils/colors.ts
  - frontend/src/types/movement.ts
  - frontend/src/api/movements.ts
  - frontend/src/api/sources.ts
  - frontend/src/api/dcs.ts
  - frontend/src/pages/Dashboard.tsx
autonomous: true
must_haves:
  truths:
    - "User can open operation form from Dashboard"
    - "User can select operation type from dropdown"
    - "User can search and select product by barcode/SKU"
    - "Dynamic fields appear based on operation type (source_id for returns, dc_id for shipment)"
    - "Form validates required fields before submission"
    - "Successful operation shows success message and refreshes data"
  artifacts:
    - path: "frontend/src/pages/Movements/OperationForm.tsx"
      provides: "Modal form for executing stock operations"
      min_lines: 120
    - path: "frontend/src/components/products/ProductSelect.tsx"
      provides: "Autocomplete for product selection"
      exports: ["ProductSelect (default)"]
    - path: "frontend/src/utils/operationFields.ts"
      provides: "Operation type configuration"
      exports: ["OPERATION_CONFIG", "OPERATION_LABELS"]
    - path: "frontend/src/api/movements.ts"
      provides: "Create movement API"
      exports: ["createMovement"]
  key_links:
    - from: "frontend/src/pages/Movements/OperationForm.tsx"
      to: "frontend/src/utils/operationFields.ts"
      via: "Form.useWatch + conditional rendering"
      pattern: "OPERATION_CONFIG\\[operationType\\]"
    - from: "frontend/src/pages/Movements/OperationForm.tsx"
      to: "frontend/src/api/movements.ts"
      via: "form submit"
      pattern: "createMovement\\("
    - from: "frontend/src/components/products/ProductSelect.tsx"
      to: "frontend/src/api/products.ts"
      via: "debounced search"
      pattern: "searchProducts"
---

<objective>
Build Operation Form with dynamic fields and product autocomplete for conducting stock operations.

Purpose: Enable managers to execute any of the 9 stock operation types with proper validation and conditional fields.
Output: Modal form that submits operations to backend API with correct field combinations.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-frontend-reports/05-RESEARCH.md

# Backend API: POST /api/stock/movements
# Request body: { operation_type, product_id, quantity, source_id?, distribution_center_id? }
# Operation types requiring source_id: RETURN_PICKUP, RETURN_DEFECT, SELF_PURCHASE
# Operation types requiring distribution_center_id: SHIPMENT_RC
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create types, utilities, and API functions</name>
  <files>
    frontend/src/types/movement.ts
    frontend/src/utils/operationFields.ts
    frontend/src/utils/colors.ts
    frontend/src/api/movements.ts
    frontend/src/api/sources.ts
    frontend/src/api/dcs.ts
  </files>
  <action>
Create types and utilities for operations.

types/movement.ts:
- OperationType enum: receipt, receipt_defect, shipment_rc, return_pickup, return_defect, self_purchase, write_off, restoration, utilization
- MovementCreate: operation_type, product_id, quantity, source_id?, distribution_center_id?
- MovementResponse: id, operation_type, product_id, quantity, source_id?, distribution_center_id?, created_at, product (with barcode, seller_sku)

utils/operationFields.ts:
- OPERATION_CONFIG: maps operation type to { sourceRequired: boolean, dcRequired: boolean }
  - shipment_rc: dcRequired: true
  - return_pickup, return_defect, self_purchase: sourceRequired: true
  - others: neither required
- OPERATION_LABELS: Russian labels for each operation type

utils/colors.ts:
- MOVEMENT_COLORS: map operation types to colors
  - Green (stock+): receipt, return_pickup, self_purchase, restoration
  - Orange (defect): receipt_defect, return_defect, write_off
  - Blue (shipment): shipment_rc
  - Red (utilization): utilization
- getMovementColor(type): returns color string

api/movements.ts:
- createMovement(data): POST /api/stock/movements

api/sources.ts:
- getSources(): GET /api/sources/ - returns array of { id, name }

api/dcs.ts:
- getDCs(): GET /api/distribution-centers/ - returns array of { id, name }
</action>
  <verify>
    cd frontend && npx tsc --noEmit
  </verify>
  <done>
All types, operation configuration, color mapping, and API functions created.
</done>
</task>

<task type="auto">
  <name>Task 2: Create ProductSelect autocomplete component</name>
  <files>
    frontend/src/components/products/ProductSelect.tsx
  </files>
  <action>
Create debounced product search autocomplete.

ProductSelect.tsx:
- Props: value, onChange (standard Ant Design Select props)
- Use Select with showSearch and filterOption={false}
- onSearch: debounce 300ms, call searchProducts(query)
- Format options as: `{barcode} | {seller_sku} | {brand}`
- Show loading state while searching
- Minimum 2 characters before search
- Empty options array when query too short or cleared

Use lodash.debounce or custom debounce with useEffect cleanup.
</action>
  <verify>
    cd frontend && npx tsc --noEmit
  </verify>
  <done>
ProductSelect component with debounced search ready for use in operation form.
</done>
</task>

<task type="auto">
  <name>Task 3: Create SourceSelect and DCSelect components</name>
  <files>
    frontend/src/components/common/SourceSelect.tsx
    frontend/src/components/common/DCSelect.tsx
  </files>
  <action>
Create dropdown components for sources and distribution centers.

SourceSelect.tsx:
- Load sources on mount via getSources()
- Select with options: { value: id, label: name }
- Show loading state
- Props: value, onChange, placeholder (optional)

DCSelect.tsx:
- Load DCs on mount via getDCs()
- Same structure as SourceSelect
- Props: value, onChange, placeholder (optional)

Both should handle loading and error states gracefully.
</action>
  <verify>
    cd frontend && npx tsc --noEmit
  </verify>
  <done>
SourceSelect and DCSelect components ready for use in operation form.
</done>
</task>

<task type="auto">
  <name>Task 4: Create OperationForm with dynamic fields</name>
  <files>
    frontend/src/pages/Movements/OperationForm.tsx
    frontend/src/pages/Dashboard.tsx
  </files>
  <action>
Create operation form modal with conditional fields.

OperationForm.tsx:
- Props: open, onClose, onSuccess
- Modal with Form inside
- Form fields:
  1. operation_type (Select with OPERATION_LABELS)
  2. product_id (ProductSelect)
  3. quantity (InputNumber, min=1)
  4. source_id (SourceSelect) - ONLY if config.sourceRequired
  5. distribution_center_id (DCSelect) - ONLY if config.dcRequired

- Use Form.useWatch('operation_type', form) to get current selection
- Get config from OPERATION_CONFIG[operationType]
- Conditional rendering for source_id and distribution_center_id fields
- onSubmit: call createMutation, show success message, call onSuccess, close modal
- Reset form when modal closes

Dashboard.tsx update:
- Add "Провести операцию" Button that opens OperationForm modal
- Pass onSuccess callback that refreshes products and summary

Use message.success() for success feedback.
</action>
  <verify>
    cd frontend && npm run build
  </verify>
  <done>
OperationForm modal with dynamic fields working, accessible from Dashboard via button.
</done>
</task>

</tasks>

<verification>
1. Login and navigate to Dashboard
2. Click "Провести операцию" button - modal should open
3. Select operation type "Отгрузка в РЦ" - DC dropdown should appear
4. Select operation type "Возврат годного с ПВЗ" - Source dropdown should appear
5. Search for product - autocomplete should show matching products
6. Fill form and submit - success message should appear, table should refresh
7. Try to submit without required fields - validation error should show
</verification>

<success_criteria>
- Operation form opens from Dashboard button
- All 9 operation types available in dropdown
- Product autocomplete searches by barcode/SKU
- Dynamic fields appear correctly based on operation type
- Form submission creates movement in backend
- Success message shown after operation
- Products table and statistics refresh after operation
</success_criteria>

<output>
After completion, create `.planning/phases/05-frontend-reports/05-03-SUMMARY.md`
</output>
