---
phase: 05-frontend-reports
plan: 05
type: execute
wave: 5
depends_on:
  - "05-04"
files_modified:
  - frontend/src/api/client.ts
  - frontend/src/pages/Login.tsx
  - frontend/src/pages/Dashboard.tsx
  - frontend/src/pages/Movements/Journal.tsx
  - frontend/src/pages/Movements/OperationForm.tsx
  - frontend/src/components/products/ProductSelect.tsx
  - frontend/src/components/common/ErrorBoundary.tsx
  - frontend/src/hooks/useApi.ts
autonomous: true
must_haves:
  truths:
    - "All API errors show user-friendly Russian messages"
    - "All loading states show Spin or button loading indicators"
    - "JWT token expiration triggers automatic logout and redirect to login"
    - "Error boundary catches unexpected React errors"
    - "All features work in integrated end-to-end test"
  artifacts:
    - path: "frontend/src/components/common/ErrorBoundary.tsx"
      provides: "React error boundary for crash recovery"
      exports: ["ErrorBoundary"]
    - path: "frontend/src/hooks/useApi.ts"
      provides: "Reusable API hook with loading/error state"
      exports: ["useApi"]
  key_links:
    - from: "frontend/src/api/client.ts"
      to: "frontend/src/stores/authStore.ts"
      via: "401 interceptor"
      pattern: "useAuthStore.getState\\(\\).logout"
    - from: "All pages"
      to: "antd message"
      via: "error display"
      pattern: "message\\.error"
---

<objective>
Polish the frontend with comprehensive error handling, loading states, and final integration testing.

Purpose: Ensure robust user experience with proper error feedback and smooth interactions.
Output: Production-ready frontend with all requirements verified.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-frontend-reports/05-RESEARCH.md

# Requirements to verify:
# UI-11: Error handling with user messages
# UI-12: Loading states on all API calls
# UI-13: Token expiration redirect
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ErrorBoundary and useApi hook</name>
  <files>
    frontend/src/components/common/ErrorBoundary.tsx
    frontend/src/hooks/useApi.ts
  </files>
  <action>
Create error handling utilities.

ErrorBoundary.tsx:
- Class component extending React.Component with getDerivedStateFromError and componentDidCatch
- Fallback UI with error message and "Перезагрузить" button
- Log errors to console in development
- Wrap entire app in ErrorBoundary

useApi.ts:
- Custom hook for API calls with loading/error state
- Returns: { data, loading, error, execute }
- execute function wraps async API call
- Automatically shows message.error() on failure
- Usage: const { data, loading, execute } = useApi(apiFunction)
</action>
  <verify>
    cd frontend && npx tsc --noEmit
  </verify>
  <done>
ErrorBoundary and useApi hook available for consistent error handling.
</done>
</task>

<task type="auto">
  <name>Task 2: Add loading states to all components</name>
  <files>
    frontend/src/pages/Login.tsx
    frontend/src/pages/Dashboard.tsx
    frontend/src/pages/Movements/Journal.tsx
    frontend/src/pages/Movements/OperationForm.tsx
    frontend/src/components/products/ProductSelect.tsx
  </files>
  <action>
Ensure all async operations show loading indicators.

Login.tsx:
- Button loading prop tied to authStore.isLoading

Dashboard.tsx:
- Spin wrapper while stats and products load
- Skeleton for statistics cards during initial load
- Table loading prop

Journal.tsx:
- Table loading prop
- Spin for initial page load

OperationForm.tsx:
- Submit button loading state during API call
- Disable form fields during submission

ProductSelect.tsx:
- Select loading prop while searching

Pattern: Every useEffect that calls API should have corresponding loading state.
</action>
  <verify>
    cd frontend && npm run build
  </verify>
  <done>
All components show loading states during async operations.
</done>
</task>

<task type="auto">
  <name>Task 3: Verify error handling and integration test</name>
  <files>
    frontend/src/api/client.ts
    frontend/src/App.tsx
  </files>
  <action>
Verify and enhance error handling.

api/client.ts verification:
- 401 response: logout + redirect to /login (already implemented)
- Network errors: show "Ошибка сети"
- 500 errors: show error.response?.data?.detail or "Ошибка сервера"
- Timeout: show "Превышено время ожидания"

App.tsx:
- Wrap entire app in ErrorBoundary
- Add a simple NotFound page component

Integration test (manual verification checklist):
1. Login with invalid credentials - error shown
2. Login with valid credentials - redirected to dashboard
3. Search products - results update
4. Create operation - success message, data refreshes
5. Navigate to journal - movements load
6. Filter journal - results update
7. Let token expire or clear localStorage - redirect to login
8. All pages show loading states during data fetch
</action>
  <verify>
    cd frontend && npm run build
    cd frontend && npm run preview &
    # Manual testing checklist
  </verify>
  <done>
All error scenarios handled, integration verified across all features.
</done>
</task>

</tasks>

<verification>
Full integration test:

1. **Authentication Flow:**
   - Invalid login shows error
   - Valid login redirects to dashboard
   - Token persists across refresh
   - Logout clears token and redirects

2. **Dashboard:**
   - Statistics load and display
   - Products table loads with pagination
   - Search filters products
   - Operation button opens form

3. **Operations:**
   - Product autocomplete searches
   - Dynamic fields appear correctly
   - Form validates required fields
   - Submission creates movement
   - Success message shown
   - Data refreshes after operation

4. **Journal:**
   - Movements load with color tags
   - Type filter works
   - Date filter works
   - Pagination works

5. **Error Handling:**
   - API errors show Russian messages
   - Loading states visible
   - 401 triggers logout redirect
</verification>

<success_criteria>
- All UI requirements (UI-01 through UI-13) implemented and verified
- All RPT-02 requirements (dashboard statistics) working
- Error messages in Russian
- Loading indicators on all async operations
- JWT expiration handled gracefully
- Full user flow tested end-to-end
- Production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-frontend-reports/05-05-SUMMARY.md`
</output>
